2026-02-09 20:01:26 [INFO] Logging to ./outputs/train_20260209_200126.log
2026-02-09 20:01:26 [INFO] Config: {'data': {'images_dir': './data/images_train', 'metadata_csv': './data/MILK10k_Training_Metadata.csv', 'groundtruth_csv': './data/MILK10k_Training_GroundTruth.csv', 'supplement_csv': './data/MILK10k_Training_Supplement.csv', 'image_size': 224, 'batch_size': 64, 'num_workers': 8, 'val_split': 0.2, 'seed': 42}, 'model': {'backbone': 'dinov2_vitl14', 'backbone_dim': 1024, 'fusion_dim': 512, 'num_concepts': 7, 'num_classes': 11, 'variant': 'hybrid', 'residual_dim': 16, 'dropout': 0.2}, 'training': {'phase1_epochs': 10, 'phase2_epochs': 30, 'phase1_lr': 0.001, 'phase2_backbone_lr': 2e-06, 'phase2_head_lr': 0.0001, 'weight_decay': 0.05, 'label_smoothing': 0.0, 'concept_loss_weight': 5.0, 'classification_loss_weight': 1.0, 'grad_clip_norm': 1.0, 'early_stopping_patience': 7, 'use_amp': True, 'amp_dtype': 'bfloat16'}, 'logging': {'project_name': 'milk10k-cbm', 'save_dir': './outputs', 'log_interval': 10}}
2026-02-09 20:01:26 [INFO] Device: cuda
2026-02-09 20:01:26 [INFO] GPU: NVIDIA GH200 480GB (94.5 GB)
2026-02-09 20:01:26 [INFO] Train batches: 65, Val batches: 17
2026-02-09 20:01:27 [INFO] using MLP layer as FFN
2026-02-09 20:01:29 [INFO] Model variant: hybrid
2026-02-09 20:01:29 [INFO] AMP: True, dtype: torch.bfloat16, GradScaler: False
2026-02-09 20:01:31 [INFO] === Phase 1: Frozen backbone ===
2026-02-09 20:01:45 [INFO] Phase 1 | Epoch   1 | Loss: 1.6188 | Concept: 0.0347 | Cls: 1.4454 | Val Loss: 1.2844 | Val F1: 0.1861 | LR: 1.00e-03
2026-02-09 20:01:46 [INFO]   New best model saved (F1: 0.1861)
2026-02-09 20:02:00 [INFO] Phase 1 | Epoch   2 | Loss: 1.3082 | Concept: 0.0275 | Cls: 1.1706 | Val Loss: 1.2514 | Val F1: 0.2173 | LR: 1.00e-03
2026-02-09 20:02:00 [INFO]   New best model saved (F1: 0.2173)
2026-02-09 20:02:14 [INFO] Phase 1 | Epoch   3 | Loss: 1.2208 | Concept: 0.0255 | Cls: 1.0933 | Val Loss: 1.1766 | Val F1: 0.2467 | LR: 1.00e-03
2026-02-09 20:02:15 [INFO]   New best model saved (F1: 0.2467)
2026-02-09 20:02:29 [INFO] Phase 1 | Epoch   4 | Loss: 1.1812 | Concept: 0.0246 | Cls: 1.0582 | Val Loss: 1.1856 | Val F1: 0.2840 | LR: 1.00e-03
2026-02-09 20:02:30 [INFO]   New best model saved (F1: 0.2840)
2026-02-09 20:02:44 [INFO] Phase 1 | Epoch   5 | Loss: 1.1403 | Concept: 0.0238 | Cls: 1.0213 | Val Loss: 1.1008 | Val F1: 0.3084 | LR: 1.00e-03
2026-02-09 20:02:44 [INFO]   Per-class F1: AKIEC: 0.259 | BCC: 0.825 | BEN_OTH: 0.000 | BKL: 0.259 | DF: 0.000 | INF: 0.000 | MAL_OTH: 0.000 | MEL: 0.420 | NV: 0.717 | SCCKA: 0.606 | VASC: 0.308
2026-02-09 20:02:45 [INFO]   New best model saved (F1: 0.3084)
2026-02-09 20:02:59 [INFO] Phase 1 | Epoch   6 | Loss: 1.1108 | Concept: 0.0235 | Cls: 0.9935 | Val Loss: 1.0782 | Val F1: 0.3073 | LR: 1.00e-03
2026-02-09 20:02:59 [INFO]   No improvement (1/7)
2026-02-09 20:03:13 [INFO] Phase 1 | Epoch   7 | Loss: 1.0947 | Concept: 0.0238 | Cls: 0.9757 | Val Loss: 1.1439 | Val F1: 0.3143 | LR: 1.00e-03
2026-02-09 20:03:13 [INFO]   New best model saved (F1: 0.3143)
2026-02-09 20:03:27 [INFO] Phase 1 | Epoch   8 | Loss: 1.0793 | Concept: 0.0232 | Cls: 0.9633 | Val Loss: 1.1725 | Val F1: 0.2684 | LR: 1.00e-03
2026-02-09 20:03:27 [INFO]   No improvement (1/7)
2026-02-09 20:03:41 [INFO] Phase 1 | Epoch   9 | Loss: 1.0723 | Concept: 0.0233 | Cls: 0.9558 | Val Loss: 1.1490 | Val F1: 0.3213 | LR: 1.00e-03
2026-02-09 20:03:42 [INFO]   New best model saved (F1: 0.3213)
2026-02-09 20:03:56 [INFO] Phase 1 | Epoch  10 | Loss: 1.0494 | Concept: 0.0228 | Cls: 0.9352 | Val Loss: 1.1161 | Val F1: 0.3141 | LR: 1.00e-03
2026-02-09 20:03:56 [INFO]   Per-class F1: AKIEC: 0.315 | BCC: 0.827 | BEN_OTH: 0.000 | BKL: 0.352 | DF: 0.000 | INF: 0.000 | MAL_OTH: 0.000 | MEL: 0.328 | NV: 0.682 | SCCKA: 0.636 | VASC: 0.316
2026-02-09 20:03:56 [INFO]   No improvement (1/7)
2026-02-09 20:03:56 [INFO] === Phase 2: Full fine-tuning ===
2026-02-09 20:04:22 [INFO] Phase 2 | Epoch   1 | Loss: 0.9983 | Concept: 0.0216 | Cls: 0.8902 | Val Loss: 1.0448 | Val F1: 0.3346 | LR: 1.34e-06
2026-02-09 20:04:24 [INFO]   New best model saved (F1: 0.3346)
2026-02-09 20:04:48 [INFO] Phase 2 | Epoch   2 | Loss: 0.9270 | Concept: 0.0209 | Cls: 0.8225 | Val Loss: 1.0185 | Val F1: 0.3382 | LR: 2.00e-06
2026-02-09 20:04:51 [INFO]   New best model saved (F1: 0.3382)
2026-02-09 20:05:15 [INFO] Phase 2 | Epoch   3 | Loss: 0.8958 | Concept: 0.0205 | Cls: 0.7936 | Val Loss: 0.9750 | Val F1: 0.3529 | LR: 1.99e-06
2026-02-09 20:05:17 [INFO]   New best model saved (F1: 0.3529)
2026-02-09 20:05:42 [INFO] Phase 2 | Epoch   4 | Loss: 0.8826 | Concept: 0.0205 | Cls: 0.7802 | Val Loss: 0.9608 | Val F1: 0.3551 | LR: 1.96e-06
2026-02-09 20:05:44 [INFO]   New best model saved (F1: 0.3551)
2026-02-09 20:06:09 [INFO] Phase 2 | Epoch   5 | Loss: 0.8666 | Concept: 0.0203 | Cls: 0.7653 | Val Loss: 1.0157 | Val F1: 0.3471 | LR: 1.93e-06
2026-02-09 20:06:09 [INFO]   Per-class F1: AKIEC: 0.420 | BCC: 0.850 | BEN_OTH: 0.000 | BKL: 0.422 | DF: 0.000 | INF: 0.000 | MAL_OTH: 0.000 | MEL: 0.406 | NV: 0.761 | SCCKA: 0.584 | VASC: 0.375
2026-02-09 20:06:09 [INFO]   No improvement (1/7)
2026-02-09 20:06:33 [INFO] Phase 2 | Epoch   6 | Loss: 0.8159 | Concept: 0.0198 | Cls: 0.7167 | Val Loss: 0.9185 | Val F1: 0.3904 | LR: 1.88e-06
2026-02-09 20:06:36 [INFO]   New best model saved (F1: 0.3904)
2026-02-09 20:07:00 [INFO] Phase 2 | Epoch   7 | Loss: 0.7808 | Concept: 0.0196 | Cls: 0.6830 | Val Loss: 0.9275 | Val F1: 0.4008 | LR: 1.82e-06
2026-02-09 20:07:03 [INFO]   New best model saved (F1: 0.4008)
2026-02-09 20:07:27 [INFO] Phase 2 | Epoch   8 | Loss: 0.7510 | Concept: 0.0196 | Cls: 0.6529 | Val Loss: 0.9699 | Val F1: 0.3630 | LR: 1.75e-06
2026-02-09 20:07:27 [INFO]   No improvement (1/7)
2026-02-09 20:07:52 [INFO] Phase 2 | Epoch   9 | Loss: 0.7224 | Concept: 0.0195 | Cls: 0.6250 | Val Loss: 0.8969 | Val F1: 0.4104 | LR: 1.68e-06
2026-02-09 20:07:54 [INFO]   New best model saved (F1: 0.4104)
2026-02-09 20:08:19 [INFO] Phase 2 | Epoch  10 | Loss: 0.7002 | Concept: 0.0192 | Cls: 0.6044 | Val Loss: 0.9227 | Val F1: 0.3886 | LR: 1.59e-06
2026-02-09 20:08:19 [INFO]   Per-class F1: AKIEC: 0.459 | BCC: 0.875 | BEN_OTH: 0.200 | BKL: 0.480 | DF: 0.000 | INF: 0.000 | MAL_OTH: 0.000 | MEL: 0.466 | NV: 0.772 | SCCKA: 0.689 | VASC: 0.333
2026-02-09 20:08:19 [INFO]   No improvement (1/7)
2026-02-09 20:08:44 [INFO] Phase 2 | Epoch  11 | Loss: 0.6722 | Concept: 0.0190 | Cls: 0.5771 | Val Loss: 0.8637 | Val F1: 0.4376 | LR: 1.50e-06
2026-02-09 20:08:46 [INFO]   New best model saved (F1: 0.4376)
2026-02-09 20:09:10 [INFO] Phase 2 | Epoch  12 | Loss: 0.6453 | Concept: 0.0188 | Cls: 0.5512 | Val Loss: 0.9072 | Val F1: 0.4357 | LR: 1.40e-06
2026-02-09 20:09:10 [INFO]   No improvement (1/7)
2026-02-09 20:09:35 [INFO] Phase 2 | Epoch  13 | Loss: 0.6143 | Concept: 0.0188 | Cls: 0.5205 | Val Loss: 0.9008 | Val F1: 0.4212 | LR: 1.30e-06
2026-02-09 20:09:35 [INFO]   No improvement (2/7)
2026-02-09 20:10:00 [INFO] Phase 2 | Epoch  14 | Loss: 0.5984 | Concept: 0.0186 | Cls: 0.5056 | Val Loss: 0.8876 | Val F1: 0.4399 | LR: 1.19e-06
2026-02-09 20:10:02 [INFO]   New best model saved (F1: 0.4399)
2026-02-09 20:10:27 [INFO] Phase 2 | Epoch  15 | Loss: 0.5887 | Concept: 0.0188 | Cls: 0.4947 | Val Loss: 0.8929 | Val F1: 0.4210 | LR: 1.08e-06
2026-02-09 20:10:27 [INFO]   Per-class F1: AKIEC: 0.514 | BCC: 0.888 | BEN_OTH: 0.200 | BKL: 0.470 | DF: 0.143 | INF: 0.000 | MAL_OTH: 0.000 | MEL: 0.503 | NV: 0.770 | SCCKA: 0.667 | VASC: 0.476
2026-02-09 20:10:27 [INFO]   No improvement (1/7)
2026-02-09 20:10:51 [INFO] Phase 2 | Epoch  16 | Loss: 0.5625 | Concept: 0.0183 | Cls: 0.4709 | Val Loss: 0.9271 | Val F1: 0.4046 | LR: 9.72e-07
2026-02-09 20:10:51 [INFO]   No improvement (2/7)
2026-02-09 20:11:16 [INFO] Phase 2 | Epoch  17 | Loss: 0.5688 | Concept: 0.0185 | Cls: 0.4763 | Val Loss: 0.8950 | Val F1: 0.4275 | LR: 8.62e-07
2026-02-09 20:11:16 [INFO]   No improvement (3/7)
2026-02-09 20:11:40 [INFO] Phase 2 | Epoch  18 | Loss: 0.5504 | Concept: 0.0181 | Cls: 0.4599 | Val Loss: 0.8983 | Val F1: 0.4205 | LR: 7.54e-07
2026-02-09 20:11:40 [INFO]   No improvement (4/7)
2026-02-09 20:12:05 [INFO] Phase 2 | Epoch  19 | Loss: 0.5256 | Concept: 0.0181 | Cls: 0.4352 | Val Loss: 0.9398 | Val F1: 0.4411 | LR: 6.49e-07
2026-02-09 20:12:07 [INFO]   New best model saved (F1: 0.4411)
2026-02-09 20:12:32 [INFO] Phase 2 | Epoch  20 | Loss: 0.5107 | Concept: 0.0179 | Cls: 0.4211 | Val Loss: 0.9201 | Val F1: 0.4435 | LR: 5.48e-07
2026-02-09 20:12:32 [INFO]   Per-class F1: AKIEC: 0.538 | BCC: 0.887 | BEN_OTH: 0.364 | BKL: 0.533 | DF: 0.000 | INF: 0.000 | MAL_OTH: 0.000 | MEL: 0.536 | NV: 0.796 | SCCKA: 0.680 | VASC: 0.545
2026-02-09 20:12:34 [INFO]   New best model saved (F1: 0.4435)
2026-02-09 20:12:58 [INFO] Phase 2 | Epoch  21 | Loss: 0.4954 | Concept: 0.0180 | Cls: 0.4056 | Val Loss: 0.9498 | Val F1: 0.4471 | LR: 4.53e-07
2026-02-09 20:13:01 [INFO]   New best model saved (F1: 0.4471)
2026-02-09 20:13:25 [INFO] Phase 2 | Epoch  22 | Loss: 0.4953 | Concept: 0.0181 | Cls: 0.4046 | Val Loss: 0.9082 | Val F1: 0.4567 | LR: 3.64e-07
2026-02-09 20:13:27 [INFO]   New best model saved (F1: 0.4567)
2026-02-09 20:13:52 [INFO] Phase 2 | Epoch  23 | Loss: 0.4832 | Concept: 0.0179 | Cls: 0.3938 | Val Loss: 0.9175 | Val F1: 0.4590 | LR: 2.83e-07
2026-02-09 20:13:54 [INFO]   New best model saved (F1: 0.4590)
2026-02-09 20:14:19 [INFO] Phase 2 | Epoch  24 | Loss: 0.4853 | Concept: 0.0177 | Cls: 0.3966 | Val Loss: 0.9221 | Val F1: 0.4577 | LR: 2.11e-07
2026-02-09 20:14:19 [INFO]   No improvement (1/7)
2026-02-09 20:14:43 [INFO] Phase 2 | Epoch  25 | Loss: 0.4715 | Concept: 0.0180 | Cls: 0.3816 | Val Loss: 0.9276 | Val F1: 0.4596 | LR: 1.48e-07
2026-02-09 20:14:43 [INFO]   Per-class F1: AKIEC: 0.567 | BCC: 0.893 | BEN_OTH: 0.364 | BKL: 0.527 | DF: 0.143 | INF: 0.000 | MAL_OTH: 0.000 | MEL: 0.552 | NV: 0.789 | SCCKA: 0.699 | VASC: 0.522
2026-02-09 20:14:46 [INFO]   New best model saved (F1: 0.4596)
2026-02-09 20:15:10 [INFO] Phase 2 | Epoch  26 | Loss: 0.4576 | Concept: 0.0179 | Cls: 0.3681 | Val Loss: 0.9350 | Val F1: 0.4548 | LR: 9.56e-08
2026-02-09 20:15:10 [INFO]   No improvement (1/7)
2026-02-09 20:15:35 [INFO] Phase 2 | Epoch  27 | Loss: 0.4683 | Concept: 0.0177 | Cls: 0.3799 | Val Loss: 0.9266 | Val F1: 0.4537 | LR: 5.42e-08
2026-02-09 20:15:35 [INFO]   No improvement (2/7)
2026-02-09 20:15:59 [INFO] Phase 2 | Epoch  28 | Loss: 0.4474 | Concept: 0.0178 | Cls: 0.3583 | Val Loss: 0.9257 | Val F1: 0.4645 | LR: 2.42e-08
2026-02-09 20:16:02 [INFO]   New best model saved (F1: 0.4645)
2026-02-09 20:16:26 [INFO] Phase 2 | Epoch  29 | Loss: 0.4588 | Concept: 0.0178 | Cls: 0.3696 | Val Loss: 0.9244 | Val F1: 0.4572 | LR: 6.07e-09
2026-02-09 20:16:26 [INFO]   No improvement (1/7)
2026-02-09 20:16:51 [INFO] Phase 2 | Epoch  30 | Loss: 0.4669 | Concept: 0.0178 | Cls: 0.3781 | Val Loss: 0.9242 | Val F1: 0.4572 | LR: 0.00e+00
2026-02-09 20:16:51 [INFO]   Per-class F1: AKIEC: 0.592 | BCC: 0.890 | BEN_OTH: 0.364 | BKL: 0.530 | DF: 0.143 | INF: 0.000 | MAL_OTH: 0.000 | MEL: 0.548 | NV: 0.791 | SCCKA: 0.696 | VASC: 0.476
2026-02-09 20:16:51 [INFO]   No improvement (2/7)
2026-02-09 20:16:51 [INFO] Training complete. Best macro F1: 0.4645
